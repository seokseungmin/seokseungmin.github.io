---
title: "내 위치 기반 공공 와이파이 정보를 제공하는 웹서비스 개발"
excerpt: "[제로베이스] 내 위치 기반 공공 와이파이 정보를 제공하는 웹서비스 개발"

categories:
  - Project
tags:
  - [Project]

permalink: /categories/공공와이파이웹서비스/ # url

toc: true
toc_sticky: true

date: 2024-07-04
last_modified_at: 2024-07-04
---

# 웹 서비스 개발과정

서울 공공 와이파이 Open API는 아래 링크에서 가져와서 사용.
[Seoul Data Link](https://data.seoul.go.kr/dataList/OA-20883/S/1/datasetView.do)

샘플 URL, 요청인자와 출력값등을 먼저 확인하고 해당 데이터가 잘 전달되는지 간단하게 테스트 해보기 위해 Postman으로 먼저 샘플 URL로 Get방식으로 요청을 보내
응답데이터를 확인해 보았습니다.

키는 서울 공공와이파이 사이트에 가입하셔서 인증키 신청하셔서 발급 받으시면 됩니다.
http://openapi.seoul.go.kr:8088/7378727a7473656f3537714e6f7557/json/TbPublicWifiInfo/1/5
5개 정도만 받아서 확인해보니, 잘 넘어오는군요.

```json
{
    "TbPublicWifiInfo": {
        "list_total_count": 24584,
        "RESULT": {
            "CODE": "INFO-000",
            "MESSAGE": "정상 처리되었습니다"
        },
        "row": [
            {
                "X_SWIFI_MGR_NO": "ARI00019",
                "X_SWIFI_WRDOFC": "서대문구",
                "X_SWIFI_MAIN_NM": "상수도사업본부",
                "X_SWIFI_ADRES1": "서소문로 51",
                "X_SWIFI_ADRES2": "본관 4F",
                "X_SWIFI_INSTL_FLOOR": "",
                "X_SWIFI_INSTL_TY": "7-1-3. 공공 - 시산하기관",
                "X_SWIFI_INSTL_MBY": "서울시(AP)",
                "X_SWIFI_SVC_SE": "공공WiFi",
                "X_SWIFI_CMCWR": "자가망_수도사업소망",
                "X_SWIFI_CNSTC_YEAR": "2019",
                "X_SWIFI_INOUT_DOOR": "실내",
                "X_SWIFI_REMARS3": "",
                "LAT": "37.561924",
                "LNT": "126.96675",
                "WORK_DTTM": "2024-07-04 11:12:58.0"
            },
            {
                "X_SWIFI_MGR_NO": "DDM200019",
                "X_SWIFI_WRDOFC": "동대문구",
                "X_SWIFI_MAIN_NM": "행복마을경로당",
                "X_SWIFI_ADRES1": "고산자로56길 53",
                "X_SWIFI_ADRES2": "1층 거실",
                "X_SWIFI_INSTL_FLOOR": "1",
                "X_SWIFI_INSTL_TY": "6-2. 복지 - 노인",
                "X_SWIFI_INSTL_MBY": "자치구",
                "X_SWIFI_SVC_SE": "",
                "X_SWIFI_CMCWR": "임대망",
                "X_SWIFI_CNSTC_YEAR": "2021",
                "X_SWIFI_INOUT_DOOR": "실내",
                "X_SWIFI_REMARS3": "",
                "LAT": "37.589996",
                "LNT": "127.03865",
                "WORK_DTTM": "2024-07-04 11:12:59.0"
            },
            {
                "X_SWIFI_MGR_NO": "DDM200020",
                "X_SWIFI_WRDOFC": "동대문구",
                "X_SWIFI_MAIN_NM": "전농1동경로당",
                "X_SWIFI_ADRES1": "전농로27길 81",
                "X_SWIFI_ADRES2": "1층 안방 문 앞",
                "X_SWIFI_INSTL_FLOOR": "1",
                "X_SWIFI_INSTL_TY": "6-2. 복지 - 노인",
                "X_SWIFI_INSTL_MBY": "자치구",
                "X_SWIFI_SVC_SE": "",
                "X_SWIFI_CMCWR": "임대망",
                "X_SWIFI_CNSTC_YEAR": "2021",
                "X_SWIFI_INOUT_DOOR": "실내",
                "X_SWIFI_REMARS3": "",
                "LAT": "37.578793",
                "LNT": "127.052124",
                "WORK_DTTM": "2024-07-04 11:12:59.0"
            },
            {
                "X_SWIFI_MGR_NO": "DDM240009",
                "X_SWIFI_WRDOFC": "동대문구",
                "X_SWIFI_MAIN_NM": "신답초스쿨존",
                "X_SWIFI_ADRES1": "전농동 625-6",
                "X_SWIFI_ADRES2": "JN1_C077",
                "X_SWIFI_INSTL_FLOOR": "-",
                "X_SWIFI_INSTL_TY": "1. 주요거리",
                "X_SWIFI_INSTL_MBY": "자치구",
                "X_SWIFI_SVC_SE": "",
                "X_SWIFI_CMCWR": "자가망(U-무선망)",
                "X_SWIFI_CNSTC_YEAR": "2023",
                "X_SWIFI_INOUT_DOOR": "실외",
                "X_SWIFI_REMARS3": "",
                "LAT": "37.577408",
                "LNT": "127.04498",
                "WORK_DTTM": "2024-07-04 11:12:59.0"
            },
            {
                "X_SWIFI_MGR_NO": "ARI00020",
                "X_SWIFI_WRDOFC": "서대문구",
                "X_SWIFI_MAIN_NM": "상수도사업본부",
                "X_SWIFI_ADRES1": "서소문로 51",
                "X_SWIFI_ADRES2": "본관 4F",
                "X_SWIFI_INSTL_FLOOR": "",
                "X_SWIFI_INSTL_TY": "7-1-3. 공공 - 시산하기관",
                "X_SWIFI_INSTL_MBY": "서울시(AP)",
                "X_SWIFI_SVC_SE": "공공WiFi",
                "X_SWIFI_CMCWR": "자가망_수도사업소망",
                "X_SWIFI_CNSTC_YEAR": "2019",
                "X_SWIFI_INOUT_DOOR": "실내",
                "X_SWIFI_REMARS3": "",
                "LAT": "37.561924",
                "LNT": "126.96675",
                "WORK_DTTM": "2024-07-04 11:12:58.0"
            }
        ]
    }
}
```

서울 공공 와이파이 Open API 가이드에서
"List_total_count가 1,000이 넘을 경우 Open API는 1회에 1,000건을 넘을 수 없으므로 분리해서 호출합니다." 라는 설명은
데이터를 1000개씩 나누어서 받아야 한다고 합니다.

다음 코드는, 서울시 공공 와이파이 데이터를 OpenAPI를 통해 가져와 데이터베이스에 저장하는 Java 서블릿입니다.
이 서블릿은 WifiDataFetcherServlet으로, 데이터를 API에서 가져와 데이터베이스에 저장합니다. 
전체적인 과정은 데이터베이스 연결, API 호출, 데이터 파싱 및 저장으로 구성됩니다.

```java
package com.example.controller;

import javax.servlet.ServletException;
import javax.servlet.annotation.WebServlet;
import javax.servlet.http.HttpServlet;
import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpServletResponse;
import java.io.BufferedReader;
import java.io.IOException;
import java.io.InputStreamReader;
import java.math.BigDecimal;
import java.net.HttpURLConnection;
import java.net.URL;
import java.net.URLEncoder;
import java.sql.Connection;
import java.sql.DriverManager;
import java.sql.PreparedStatement;

import org.json.JSONArray;
import org.json.JSONObject;

@WebServlet("/fetch-seoul-wifi-data")
public class WifiDataFetcherServlet extends HttpServlet {

    private static final String API_URL = "http://openapi.seoul.go.kr:8088";
    private static final String API_KEY = "506b73675173656f313943556a5343"; // OpenAPI 인증키
    private static final String SERVICE = "TbPublicWifiInfo";
    private static final String DATA_TYPE = "json";
    private static final int PAGE_SIZE = 1000; // 한번에 가져올 데이터 수
    private static final String DB_URL = "jdbc:mariadb://localhost:3306/seoul_wifi?useUnicode=true&characterEncoding=utf8mb4";
    private static final String DB_USER = "root";
    private static final String DB_PASSWORD = "zerobase";

    @Override
    protected void doGet(HttpServletRequest req, HttpServletResponse resp) throws ServletException, IOException {
        int savedCount = 0;
        Connection dbConn = null;
        PreparedStatement pstmt = null;
        try {
            // JDBC 드라이버 등록
            Class.forName("org.mariadb.jdbc.Driver");

            // 데이터베이스 연결
            dbConn = DriverManager.getConnection(DB_URL, DB_USER, DB_PASSWORD);
            String sql = "INSERT INTO WifiInfo (mgrNo, wrdofc, mainNm, adres1, adres2, instlFloor, instlTy, instlMby, svcSe, cmcwr, cnstcYear, inoutDoor, remars3, lat, lnt, workDttm) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)";
            pstmt = dbConn.prepareStatement(sql);

            // API 호출 반복
            int startIndex = 1;
            int endIndex = PAGE_SIZE;
            boolean moreData = true;

            while (moreData) {
                StringBuilder urlBuilder = new StringBuilder(API_URL);
                urlBuilder.append("/" + URLEncoder.encode(API_KEY, "UTF-8"));
                urlBuilder.append("/" + URLEncoder.encode(DATA_TYPE, "UTF-8"));
                urlBuilder.append("/" + URLEncoder.encode(SERVICE, "UTF-8"));
                urlBuilder.append("/" + URLEncoder.encode(String.valueOf(startIndex), "UTF-8"));
                urlBuilder.append("/" + URLEncoder.encode(String.valueOf(endIndex), "UTF-8"));

                URL url = new URL(urlBuilder.toString());
                HttpURLConnection conn = (HttpURLConnection) url.openConnection();
                conn.setRequestMethod("GET");
                conn.setRequestProperty("Content-type", "application/json");
                System.out.println("Response code: " + conn.getResponseCode());

                BufferedReader rd;
                if (conn.getResponseCode() >= 200 && conn.getResponseCode() <= 300) {
                    rd = new BufferedReader(new InputStreamReader(conn.getInputStream(), "UTF-8"));
                } else {
                    rd = new BufferedReader(new InputStreamReader(conn.getErrorStream(), "UTF-8"));
                }
                StringBuilder content = new StringBuilder();
                String line;
                while ((line = rd.readLine()) != null) {
                    content.append(line);
                }
                rd.close();
                conn.disconnect();

                System.out.println("API Response: " + content.toString());

                JSONObject json = new JSONObject(content.toString());
                JSONObject tbPublicWifiInfo = json.getJSONObject("TbPublicWifiInfo");
                JSONArray rows = tbPublicWifiInfo.getJSONArray("row");
                int totalDataCount = tbPublicWifiInfo.getInt("list_total_count");

                for (int i = 0; i < rows.length(); i++) {
                    JSONObject row = rows.getJSONObject(i);
                    System.out.println("Row Data: " + row.toString());
                    pstmt.setString(1, row.getString("X_SWIFI_MGR_NO"));
                    pstmt.setString(2, row.getString("X_SWIFI_WRDOFC"));
                    pstmt.setString(3, row.getString("X_SWIFI_MAIN_NM"));
                    pstmt.setString(4, row.getString("X_SWIFI_ADRES1"));
                    pstmt.setString(5, row.getString("X_SWIFI_ADRES2"));
                    pstmt.setString(6, row.getString("X_SWIFI_INSTL_FLOOR"));
                    pstmt.setString(7, row.getString("X_SWIFI_INSTL_TY"));
                    pstmt.setString(8, row.getString("X_SWIFI_INSTL_MBY"));
                    pstmt.setString(9, row.getString("X_SWIFI_SVC_SE"));
                    pstmt.setString(10, row.getString("X_SWIFI_CMCWR"));
                    pstmt.setString(11, row.getString("X_SWIFI_CNSTC_YEAR"));
                    pstmt.setString(12, row.getString("X_SWIFI_INOUT_DOOR"));
                    pstmt.setString(13, row.getString("X_SWIFI_REMARS3"));
                    pstmt.setBigDecimal(14, new BigDecimal(row.getString("LAT")));
                    pstmt.setBigDecimal(15, new BigDecimal(row.getString("LNT")));
                    pstmt.setString(16, row.getString("WORK_DTTM"));
                    pstmt.addBatch();
                    savedCount++;
                }

                pstmt.executeBatch();

                startIndex += PAGE_SIZE;
                endIndex += PAGE_SIZE;

                if (startIndex > totalDataCount) {
                    moreData = false;
                }
            }

        } catch (Exception e) {
            e.printStackTrace();
        } finally {
            if (pstmt != null) try {
                pstmt.close();
            } catch (Exception e) {
                e.printStackTrace();
            }
            if (dbConn != null) try {
                dbConn.close();
            } catch (Exception e) {
                e.printStackTrace();
            }
        }

        req.setAttribute("savedCount", savedCount);
        req.getRequestDispatcher("/WEB-INF/views/fetchResult.jsp").forward(req, resp);
    }
}
```

JSON 응답을 파싱하여 원하는 데이터를 추출하는 과정을 정리하면,

## JSON 데이터 파싱 과정
JSON 응답 문자열을 JSONObject로 변환

```java
JSONObject json = new JSONObject(content.toString());
```

이 줄은 서버로부터 받은 응답 문자열을 JSONObject로 변환하는 과정입니다. 
content.toString()은 API 응답을 문자열로 변환한 것입니다. 
JSONObject는 키-값 쌍으로 이루어진 JSON 객체를 표현합니다.
예를 들어, 응답 문자열이 다음과 같다고 가정합니다:

```json
{
    "TbPublicWifiInfo": {
        "list_total_count": 24584,
        "RESULT": {
            "CODE": "INFO-000",
            "MESSAGE": "정상 처리되었습니다"
        },
        "row": [
            {
                "X_SWIFI_MGR_NO": "ARI00019",
                "X_SWIFI_WRDOFC": "서대문구",
                "X_SWIFI_MAIN_NM": "상수도사업본부",
                "X_SWIFI_ADRES1": "서소문로 51",
                "X_SWIFI_ADRES2": "본관 4F",
                "X_SWIFI_INSTL_FLOOR": "",
                "X_SWIFI_INSTL_TY": "7-1-3. 공공 - 시산하기관",
                "X_SWIFI_INSTL_MBY": "서울시(AP)",
                "X_SWIFI_SVC_SE": "공공WiFi",
                "X_SWIFI_CMCWR": "자가망_수도사업소망",
                "X_SWIFI_CNSTC_YEAR": "2019",
                "X_SWIFI_INOUT_DOOR": "실내",
                "X_SWIFI_REMARS3": "",
                "LAT": "37.561924",
                "LNT": "126.96675",
                "WORK_DTTM": "2024-07-04 11:12:58.0"
            },
            ...
        ]
    }
}
```

특정 키를 가진 JSONObject를 추출

```java
JSONObject tbPublicWifiInfo = json.getJSONObject("TbPublicWifiInfo");
```

이 줄은 json 객체에서 "TbPublicWifiInfo"라는 키를 가진 JSON 객체를 추출합니다.
이 객체는 JSON 응답의 루트에 있는 "TbPublicWifiInfo"에 해당합니다. 
예를 들어 위의 JSON 응답에서 tbPublicWifiInfo는 다음과 같은 구조를 가집니다:

```json
{
    "list_total_count": 24584,
    "RESULT": {
        "CODE": "INFO-000",
        "MESSAGE": "정상 처리되었습니다"
    },
    "row": [
        {
            "X_SWIFI_MGR_NO": "ARI00019",
            "X_SWIFI_WRDOFC": "서대문구",
            "X_SWIFI_MAIN_NM": "상수도사업본부",
            ...
        },
        ...
    ]
}
```

특정 키를 가진 JSONArray를 추출

```java
JSONArray rows = tbPublicWifiInfo.getJSONArray("row");
```

이 줄은 tbPublicWifiInfo 객체에서 "row"라는 키를 가진 JSON 배열을 추출합니다. 
이 배열은 여러 개의 와이파이 정보 객체로 구성되어 있습니다.
위의 JSON 예제에서 rows는 다음과 같은 구조를 가집니다:

```json
[
    {
        "X_SWIFI_MGR_NO": "ARI00019",
        "X_SWIFI_WRDOFC": "서대문구",
        "X_SWIFI_MAIN_NM": "상수도사업본부",
        ...
    },
    ...
]
```

요약
이 과정을 통해 API로부터 받은 JSON 응답에서 원하는 데이터를 추출할 수 있습니다. 
JSONObject와 JSONArray를 사용하여 계층적 구조의 JSON 데이터를 효율적으로 파싱하고 필요한 정보를 추출합니다.
각 단계는 다음과 같습니다:

전체 JSON 응답을 JSONObject로 변환
특정 키를 가진 JSONObject 추출 ("TbPublicWifiInfo")
특정 키를 가진 JSONArray 추출 ("row")
이 추출 과정을 통해 각 와이파이 정보를 개별적으로 접근할 수 있으며, 이를 데이터베이스에 삽입할 수 있습니다.

그리고 다음 과정을 이해하기 위해 ChatGPT에게 간단한 개념을 설명을 듣고 가려합니다.

```java
req.setAttribute("savedCount", savedCount);
req.getRequestDispatcher("/WEB-INF/views/fetchResult.jsp").forward(req, resp);
```

위에 코드는 Java Servlet에서 요청(Request)과 응답(Response)을 처리하는 중요한 개념입니다.

1. HttpServletRequest와 HttpServletResponse
HttpServletRequest: 클라이언트의 요청 정보를 담고 있는 객체입니다. 사용자가 보낸 데이터를 포함하며, 서버가 요청을 처리하는 데 필요한 정보를 제공합니다.
HttpServletResponse: 서버의 응답 정보를 담고 있는 객체입니다. 서버가 클라이언트에게 데이터를 보내기 위해 사용됩니다.
2. Request Attributes (요청 속성)
Attributes: HttpServletRequest 객체에 데이터를 저장할 수 있는 방법 중 하나입니다. 키-값 쌍의 형태로 데이터를 저장할 수 있으며, JSP 페이지 또는 다른 서블릿으로 전달할 수 있습니다.
req.setAttribute(String name, Object o): 요청 객체에 데이터를 저장합니다. 여기서 name은 키, o는 저장할 값입니다.
3. RequestDispatcher (요청 디스패처)
RequestDispatcher: 요청을 다른 서블릿이나 JSP 페이지로 전달(포워딩)하는 데 사용됩니다.
req.getRequestDispatcher(String path): 지정된 경로의 서블릿 또는 JSP 페이지에 대한 RequestDispatcher 객체를 반환합니다.
forward(ServletRequest request, ServletResponse response): 현재 요청과 응답 객체를 다른 서블릿이나 JSP 페이지로 전달합니다. 전달된 서블릿 또는 JSP 페이지는 클라이언트에게 응답을 보내기 전에 요청을 처리합니다.

savedCount로 전달한 값을 
fetchResult.jsp에서 받아서 처리하는 과정입니다.

```jsp
<%@ page contentType="text/html;charset=UTF-8" language="java" %>
<!DOCTYPE html>
<html>
<head>
    <title>와이파이 정보 가져오기 결과</title>
</head>
<body>
<h1>와이파이 정보 가져오기 결과</h1>
<p>${savedCount}개의 WIFI 정보를 정상적으로 저장하였습니다.</p>
<a href="index.jsp">홈으로 가기</a>
</body>
</html>
```



