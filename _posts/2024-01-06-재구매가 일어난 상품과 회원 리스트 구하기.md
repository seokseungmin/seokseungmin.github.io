---
title: "재구매가 일어난 상품과 회원 리스트 구하기"
excerpt: "재구매가 일어난 상품과 회원 리스트 구하기"

categories: SQL
tags:  SQL

permalink: /categories/재구매가 일어난 상품과 회원 리스트 구하기/ # url

toc: true
toc_sticky: true

date: 2024-01-06
last_modified_at: 2024-01-06
---

# 재구매가 일어난 상품과 회원 리스트 구하기

## 문제 설명

다음은 어느 의류 쇼핑몰의 온라인 상품 판매 정보를 담은 `ONLINE_SALE` 테이블입니다.<br>
`ONLINE_SALE` 테이블은 아래와 같은 구조로 되어있으며 `ONLINE_SALE_ID`, `USER_ID`, `PRODUCT_ID`, `SALES_AMOUNT`, `SALES_DATE`는 각각 온라인 상품 판매 ID, 회원 ID, 상품 ID, 판매량, 판매일을 나타냅니다.

| Column name    | Type    | Nullable |
|----------------|---------|----------|
| ONLINE_SALE_ID | INTEGER | FALSE    |
| USER_ID        | INTEGER | FALSE    |
| PRODUCT_ID     | INTEGER | FALSE    |
| SALES_AMOUNT   | INTEGER | FALSE    |
| SALES_DATE     | DATE    | FALSE    |

동일한 날짜, 회원 ID, 상품 ID 조합에 대해서는 하나의 판매 데이터만 존재합니다.

## 문제

`ONLINE_SALE` 테이블에서 동일한 회원이 동일한 상품을 재구매한 데이터를 구하여, 재구매한 회원 ID와 재구매한 상품 ID를 출력하는 SQL문을 작성해주세요.<br>
결과는 회원 ID를 기준으로 오름차순 정렬해주시고 회원 ID가 같다면 상품 ID를 기준으로 내림차순 정렬해주세요.

### 예시

예를 들어 `ONLINE_SALE` 테이블이 다음과 같다면

| ONLINE_SALE_ID | USER_ID | PRODUCT_ID | SALES_AMOUNT | SALES_DATE |
|----------------|---------|------------|--------------|------------|
| 1              | 1       | 3          | 2            | 2022-02-25 |
| 2              | 1       | 4          | 1            | 2022-03-01 |
| 4              | 2       | 4          | 2            | 2022-03-12 |
| 3              | 1       | 3          | 3            | 2022-03-31 |
| 5              | 3       | 5          | 1            | 2022-04-03 |
| 6              | 2       | 4          | 1            | 2022-04-06 |
| 7              | 1       | 4          | 2            | 2022-05-11 |

`USER_ID` 가 1인 유저가 `PRODUCT_ID` 가 3, 4인 상품들을 재구매하고, `USER_ID` 가 2인 유저가 `PRODUCT_ID` 가 4인 상품을 재구매 하였으므로, 다음과 같이 결과가 나와야합니다.

| USER_ID | PRODUCT_ID |
|---------|------------|
| 1       | 4          |
| 1       | 3          |
| 2       | 4          |

---

# 풀이

이 문제를 해결하기 위해 재구매한 데이터를 식별하는 SQL 쿼리를 작성해야 합니다.<br>
재구매란 동일한 회원 ID와 상품 ID로 두 번 이상 구매한 경우를 말합니다.<br>
이를 찾기 위해서는 각 회원 ID와 상품 ID 조합의 판매 횟수를 계산하고, 이 횟수가 2 이상인 경우를 찾아야 합니다.<br>

SQL 쿼리는 다음 단계를 따릅니다:<br>

ONLINE_SALE 테이블에서 USER_ID와 PRODUCT_ID를 기준으로 그룹화합니다.<br>
각 그룹의 판매 횟수를 세어 SALES_COUNT라는 이름으로 저장합니다.<br>
SALES_COUNT가 2 이상인 경우만 선택합니다.<br>
결과를 USER_ID로 오름차순, PRODUCT_ID로 내림차순으로 정렬합니다.<br>
아래는 이러한 단계를 따르는 SQL 쿼리입니다:<br>

```sql
SELECT USER_ID, PRODUCT_ID
FROM (
    SELECT USER_ID, PRODUCT_ID, COUNT(*) AS SALES_COUNT
    FROM ONLINE_SALE
    GROUP BY USER_ID, PRODUCT_ID
) AS SALES_COUNTS
WHERE SALES_COUNT > 1
ORDER BY USER_ID ASC, PRODUCT_ID DESC;
```

이 쿼리는 ONLINE_SALE 테이블에서 USER_ID와 PRODUCT_ID를 그룹화하여 판매 횟수를 세고, 그 중 판매 횟수가 2 이상인 경우만을 필터링하여 결과로 반환합니다.<br>
그 후에 요구된 정렬 순서에 맞게 결과를 정렬합니다.<br>
출처 : chatGPT
